# 音频预处理工具 (Audio Preprocessing Tool for TTS)

这是一个用于语音合成（TTS）训练的音频数据集预处理工具。它可以自动化处理、清洗和格式化原始音频和文本标注文件。

## 主要功能

- **分类处理**: 根据音频时长，自动将文件分为“短音频”、“正常音频”和“长音频”。
- **合并短音频**: 将多个短音频自动合并，并在片段之间插入静音，以达到合适的训练时长。
- **切分长音频**:
    - 基于静音检测找到最佳切分点，使用 `whisperx` 进行语音对齐，以实现自动标注文本切分。
    - 自动调整标点符号，将切分后位于句首的标点符号移动到上一句的句尾。
- **文本规范化**:
    - 可在 `config.yaml` 中自定义灵活的**文本替换规则**，用于清理或规范化标注文本。
    - `{SKIP}` 规则，用于跳过不需要处理的音频文件。
- **去除重复内容**: 自动检测并移除具有重复标注文本的音频文件，避免数据冗余。
- **配置**: 所有关键参数均可通过 `config.yaml` 文件进行配置。
- **输出结构**:
    - 生成结构化的输出目录，包含处理好的音频文件。
    - 生成详细的**合并、切分和去重记录**，方便溯源。
    - 自动生成一个 `.list` 标注文件。

## 如何使用

### 1. 安装依赖

在开始之前，请确保您已安装 Python和ffmpeg。然后，通过以下命令安装所有必需的库：

```bash
pip install -r requirements.txt
```

### 2. 准备数据

将您的原始 `.wav` 音频文件和对应的 `.lab` 文本标注文件放入一个文件夹中。例如：

```
input/
└───Data/
    ├───audio1.wav
    ├───audio1.lab
    ├───audio2.wav
    ├───audio2.lab
    └───...
```

### 3. 配置 `config.yaml`

打开 `config.yaml` 文件，根据您的需求修改以下核心参数：

- `root_dir`: 设置为您存放原始数据的文件夹路径（例如 `D:\data\hutao`）。
- `recursive`: 如果您的数据分布在多个子文件夹中，请设置为 `true`。
- `split_and_merge`:
    - `short_threshold`: 小于此时长（秒）的音频将被视为**短音频**并进行合并。
    - `long_threshold`: 大于此时长（秒）的音频将被视为**长音频**并进行切分。
- `split`:
    - `max_duration` / `min_duration`: 切分后单个音频的最大和最小时长。
- `text`:
    - `replace_map`: 在这里添加您自己的文本替换规则。

### 4. 运行程序

配置完成后，直接运行主程序即可：

```bash
python main.py
```

程序将开始处理，并在 `output` 文件夹中生成结果。

## 输出文件结构

处理完成后，`output` 文件夹的结构如下：

```
output/
├───Data.log           # 本次处理的详细日志
├───Data.list           # 可直接用于训练的标注列表文件
└───Data/                 # 处理后的音频及相关记录
    ├───！合并记录.txt
    ├───！切分记录.txt
    ├───！去重记录.txt
    ├───！00-25-30.txt    # 处理后音频的总时长标记（文件名即时长）
    ├───Data_merged_1.wav
    ├───audio1.wav
    └───切分后/
        ├───audio2_part1.wav
        └───audio2_part2.wav
```
